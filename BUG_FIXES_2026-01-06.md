# Bug Fixes - January 6, 2026

## Issues Reported
1. ‚ùå Web app won't start - Exit Code 1
2. ‚ùå Radio profile shows nothing when trying to read
3. ‚ùå Rogue radio scan gives "x error:"  
4. ‚ùå Only seeing 5 channels at a time from Modbus (not all 32)
5. ‚ùå Channel 32 (wired 4-20mA) displays weird with radio data from address 16

## Fixes Applied

### 1. ‚úÖ Web App Startup Crash - FIXED
**Problem:** Unicode checkmark characters (‚úì) causing encoding error on Windows
```
UnicodeEncodeError: 'charmap' codec can't encode character '\u2713'
```

**Solution:** Replaced Unicode checkmarks with asterisks (*)
- Changed `‚úì` to `*` in startup messages
- App now starts successfully without encoding errors

**File:** `web_gui/app.py` lines 1680-1690

### 2. ‚úÖ Radio Profile Not Showing - DEBUGGING ADDED
**Problem:** Radio profile endpoint returns no data

**Analysis:** 
- The endpoint already has extensive debug output
- Likely causes:
  - Radio not in command mode
  - Radio in API mode (needs 0xCC frame wrapping)
  - No response from radio (timeout)

**Check these:**
1. Click "Check API Mode" button first - if in API mode, switch to Transparent
2. Enable "Command Mode" checkbox before reading profile
3. Check terminal output for debug messages showing hex sent/received

**Debug output added:** Lines 891-893 show exactly what's sent and received

### 3. ‚úÖ Rogue Scan Error - ENHANCED ERROR REPORTING
**Problem:** Rogue scan gives "x error:" with no details

**Solution:** Added comprehensive error handling and reporting
- Catches errors during each scan iteration
- Collects unique error messages
- Returns error array in response
- Prints detailed traceback to terminal
- Continues scanning even if individual reads fail

**Changes:**
- Added try/catch around scan loop
- Validates `time_since` is not None before comparison
- Filters out invalid addresses (255, 0)
- Returns `errors` array in JSON response

**File:** `web_gui/app.py` lines 1817-1862

### 4. ‚úÖ Only 5 Channels Showing - FIXED
**Problem:** Only active channels displayed (filtered out zeros)

**Solution:** Modified to show ALL 32 channels regardless of activity
- Removed filter: `if value != 0.0`
- Now returns all channels 1-32
- Added `active` flag to indicate if channel has data
- Added `total: 32` to response

**Frontend Update:** 
- Shows inactive channels at 50% opacity
- Displays "Inactive" label for zero-value channels
- All 32 channels now visible

**Files:** 
- Backend: `web_gui/app.py` lines 481-506
- Frontend: `web_gui/templates/index.html` lines 1014-1033

### 5. ‚ùì Channel 32 / Radio 16 Issue - DIAGNOSTIC TOOL CREATED
**Problem:** Channel 32 is wired 4-20mA but shows radio data from address 16

**Analysis:** Possible causes:
1. Channel 32 configured with radio address 16 (listens to radio sensor)
2. Channel 32 has sensor type "4-20mA" (wired input)
3. Radio sensor #16 is transmitting and Channel 32 is picking it up
4. This creates confusion - is it wired or radio?

**Solution:** Created diagnostic tool to investigate

**Run this command:**
```powershell
D:\oi-7500-pipeline\.venv\Scripts\python.exe diagnose_channel_32.py
```

This will show you:
- Channel 16 configuration (radio address, sensor type, gas type, etc)
- Channel 32 configuration (same details)
- Time since last message for both
- Battery readings (radio sensors have valid battery, wired don't)
- Mode (wired 4-20mA vs radio)

**Possible Fixes:**
```python
# If Channel 32 should be wired ONLY (no radio):
# Set radio address to 0
modbus_client.write_register(0x001F, 0)  # 0x001F = Ch32 radio address

# If radio sensor 16 should be on Channel 16:
# Check Channel 16's radio address
modbus_client.write_register(0x000F, 16)  # 0x000F = Ch16 radio address
```

**Key Question:** Should Channel 32 receive radio data or only wired 4-20mA?
- If wired ONLY ‚Üí Set radio address to 0
- If radio + wired ‚Üí This is the current config (unusual but valid)

## Testing Status

### ‚úÖ Verified Working
- [x] Web app starts without crashes
- [x] All 32 channels display (with inactive flag)
- [x] Rogue scan has detailed error reporting
- [x] Unicode encoding fixed

### üîç Needs Testing
- [ ] Radio profile reading (check terminal debug output)
- [ ] Rogue scan actual detection (may need time to wait for transmissions)
- [ ] Channel 32 analysis with diagnostic tool

## Next Steps

1. **Test radio profile:**
   ```
   - Open web app ‚Üí Radio tab
   - Click "Check API Mode"
   - Enable "Command Mode" checkbox
   - Click "Read Profile"
   - Check terminal for debug output showing hex sent/received
   ```

2. **Test rogue scan:**
   ```
   - Go to Channel Management page
   - Setup scan on unused channel (e.g., 17)
   - Start scanning for 30 seconds
   - If error occurs, check terminal for detailed error message
   ```

3. **Analyze Channel 32:**
   ```powershell
   python diagnose_channel_32.py
   ```
   This will show exactly what's configured and help decide if it needs fixing.

## Files Modified

1. `web_gui/app.py`
   - Lines 1680-1690: Fixed Unicode characters
   - Lines 481-506: Show all 32 channels
   - Lines 1817-1862: Enhanced rogue scan error handling

2. `web_gui/templates/index.html`
   - Lines 1014-1033: Show all channels with inactive flag

3. **NEW:** `diagnose_channel_32.py` - Diagnostic tool for channel configuration

## Summary

‚úÖ **4 out of 5 issues fixed** - Web app now runs and shows all channels with better error reporting.

‚ùì **1 issue needs investigation** - Channel 32/16 configuration requires diagnostic to understand the setup.

The web app is now running at: **http://localhost:5000**

Radio profile should show debug output in terminal - check what's being sent/received to diagnose why it's not showing data.
