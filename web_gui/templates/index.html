<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OI Monitor Control Center</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.connected {
            background: #10b981;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        button.danger {
            background: #ef4444;
        }
        
        button.danger:hover {
            background: #dc2626;
        }
        
        button.success {
            background: #10b981;
        }
        
        button.success:hover {
            background: #059669;
        }
        
        .channels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .channel-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .channel-card.alert {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
        
        .channel-number {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }
        
        .channel-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }
        
        .channel-gas {
            color: #666;
            font-size: 12px;
        }
        
        .log {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log-entry {
            margin-bottom: 5px;
        }
        
        .log-entry .timestamp {
            color: #6b7280;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .info-item {
            background: #f9fafb;
            padding: 10px;
            border-radius: 5px;
        }
        
        .info-label {
            color: #666;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        .info-value {
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }
        
        .alert-banner {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap; /* Allow tabs to wrap to next line */
        }
        
        .tab {
            padding: 8px 12px; /* Smaller padding */
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            font-size: 13px; /* Slightly smaller text */
            white-space: nowrap; /* Keep text on one line */
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üî¨ OI Monitor Control Center</h1>
                    <p class="subtitle">Unified interface for OI-7530/7010/7032 gas monitors - Testing, Configuration & Monitoring</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="window.location.href='/diagnostic'" style="background: #3b82f6; padding: 15px 25px; font-size: 16px;">
                        üî¨ Data Source Diagnostic
                    </button>
                    <button onclick="window.location.href='/channels'" style="background: #10b981; padding: 15px 25px; font-size: 16px;">
                        üîß Channel Management
                    </button>
                </div>
            </div>
        </header>
        
        <div class="grid">
            <!-- Modbus Connection -->
            <div class="card">
                <h2>
                    Modbus Device 
                    <span id="modbus-status" class="status disconnected">Disconnected</span>
                </h2>
                
                <div class="form-group">
                    <label>COM Port</label>
                    <select id="modbus-port">
                        <option value="">Select Port...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Monitor Model</label>
                    <select id="monitor-model">
                        <option value="7530" selected>OI-7530 (32-channel monitor)</option>
                        <option value="7010">OI-7010 (8-channel monitor)</option>
                        <option value="7032">OI-7032 (32-channel I/O)</option>
                        <option value="custom">Custom (Enter Slave ID)</option>
                    </select>
                </div>
                
                <div class="form-group" id="slave-id-group" style="display: none;">
                    <label>Slave ID</label>
                    <input type="number" id="slave-id" value="1" min="1" max="247">
                </div>
                
                <div class="form-group">
                    <label>Baud Rate</label>
                    <select id="baudrate">
                        <option value="9600" selected>9600 (Standard)</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200 (High-speed)</option>
                    </select>
                </div>
                
                <button onclick="connectModbus()">Connect</button>
                <button onclick="disconnectModbus()" class="danger">Disconnect</button>
                <button onclick="refreshPorts()">üîÑ Refresh Ports</button>
                
                <div id="device-info" style="display:none; margin-top:15px;">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Serial Number</div>
                            <div class="info-value" id="info-serial">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Model</div>
                            <div class="info-value" id="info-model">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Network Channel</div>
                            <div class="info-value" id="info-channel">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Uptime</div>
                            <div class="info-value" id="info-uptime">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MQTT Configuration -->
            <div class="card">
                <h2>
                    MQTT Configuration
                    <span id="mqtt-status" class="status disconnected">Not Tested</span>
                </h2>
                
                <div class="form-group">
                    <label>Broker Address</label>
                    <input type="text" id="mqtt-broker" value="localhost" placeholder="192.168.1.100">
                </div>
                
                <div class="form-group">
                    <label>Port</label>
                    <input type="number" id="mqtt-port" value="1883">
                </div>
                
                <div class="form-group">
                    <label>Username (optional)</label>
                    <input type="text" id="mqtt-username" placeholder="homeassistant">
                </div>
                
                <div class="form-group">
                    <label>Password (optional)</label>
                    <input type="password" id="mqtt-password" placeholder="password">
                </div>
                
                <div class="form-group">
                    <label>Base Topic</label>
                    <input type="text" id="mqtt-topic" value="oi_monitors">
                </div>
                
                <button onclick="saveMqttConfig()" class="success">üíæ Save Configuration</button>
                <button onclick="testMqttConnection()">üîå Test Connection</button>
            </div>
            
            <!-- Radio Module -->
            <div class="card">
                <h2>
                    Radio Module (Laird)
                    <span id="radio-status" class="status disconnected">Disconnected</span>
                </h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('radio-connect-tab')">Connect</button>
                    <button class="tab" onclick="switchTab('radio-config-tab')">Configure</button>
                    <button class="tab" onclick="switchTab('radio-test-tab')">Test TX</button>
                    <button class="tab" onclick="switchTab('radio-wireless-tab')">Wireless AT</button>
                    <button class="tab" onclick="switchTab('radio-advanced-at-tab')">Advanced AT</button>
                    <button class="tab" onclick="switchTab('radio-scan-tab')">Network Scan</button>
                </div>
                
                <div id="radio-connect-tab" class="tab-content active">
                    <div class="form-group">
                        <label>COM Port</label>
                        <select id="radio-port">
                            <option value="">Select Port...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Baud Rate</label>
                        <select id="radio-baudrate">
                            <option value="9600">9600 (Sensor/Legacy)</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200 (Monitor/High-speed)</option>
                        </select>
                    </div>
                    
                    <button onclick="connectRadio()">Connect Radio</button>
                    <button onclick="disconnectRadio()" class="danger">Disconnect</button>
                    <button onclick="readRadioProfile()">üìã Read Profile</button>
                    <button onclick="checkRadioMode()" style="background: #f59e0b;">üîç Check API Mode</button>
                    <button onclick="enableApiMode()" style="background: #8b5cf6;">üîß Enable API Mode</button>
                    
                    <div style="margin-top:15px; padding:10px; background:#f3f4f6; border-radius:5px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="command-mode-toggle" onchange="toggleCommandMode()" style="width:18px; height:18px;">
                            <span style="font-size:13px; font-weight:500;">Enter Command Mode (stops data flow)</span>
                        </label>
                        <p style="color:#6b7280; font-size:11px; margin:5px 0 0 26px;">
                            Check this to send AT commands or read EEPROM. Uncheck to resume sensor data.
                        </p>
                    </div>
                    
                    <div id="api-mode-warning" style="display:none; margin-top:15px; padding:15px; background:#fef3c7; border-left: 4px solid #f59e0b; border-radius: 5px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <div>
                                <strong style="color: #92400e;">Radio is in API Mode</strong>
                                <p style="color: #78350f; margin: 5px 0; font-size: 12px;">
                                    API mode uses CC frame delimiters (0xCC prefix). AT commands may not work properly.
                                </p>
                            </div>
                        </div>
                        <button onclick="switchToTransparent()" style="background: #10b981; width: 100%;">
                            Switch to Transparent Mode (Recommended)
                        </button>
                        <p style="color: #78350f; font-size: 11px; margin-top: 5px;">
                            Note: Radio will reboot after switching. You'll need to reconnect.
                        </p>
                    </div>
                    
                    <div id="radio-info" style="display:none; margin-top:15px;">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">RSSI</div>
                                <div class="info-value" id="radio-rssi">- dBm</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">MAC Address</div>
                                <div class="info-value" id="radio-mac">-</div>
                            </div>
                        </div>
                        
                        <div id="radio-profile" style="margin-top:15px; display:none;">
                            <h3 style="font-size: 14px; color: #667eea; margin-bottom: 10px;">Radio Profile (EEPROM)</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Network Channel</div>
                                    <div class="info-value" id="profile-channel">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Mode</div>
                                    <div class="info-value" id="profile-mode">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">System ID</div>
                                    <div class="info-value" id="profile-sysid">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">API Mode</div>
                                    <div class="info-value" id="profile-api">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Baud Rate</div>
                                    <div class="info-value" id="profile-baud">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">RF Power</div>
                                    <div class="info-value" id="profile-power">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="radio-config-tab" class="tab-content">
                    <div class="form-group">
                        <label>Network Channel (1-78)</label>
                        <input type="number" id="radio-channel" value="25" min="1" max="78">
                    </div>
                    
                    <div class="form-group">
                        <label>Mode</label>
                        <select id="radio-mode">
                            <option value="false">Secondary (Receive Only)</option>
                            <option value="true">Primary (Transmit/Receive)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>System ID</label>
                        <input type="number" id="radio-sysid" value="37" min="0" max="255">
                    </div>
                    
                    <button onclick="configureRadio()">Configure Radio</button>
                </div>
                
                <div id="radio-test-tab" class="tab-content">
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                        Send test packet spoofing a sensor (Primary mode only)
                    </p>
                    
                    <div class="form-group">
                        <label>Sensor ID / Address Override</label>
                        <input type="number" id="test-sensor-addr" placeholder="Leave blank to use channel" min="1" max="255">
                    </div>
                    
                    <div class="form-group">
                        <label>Channel Number</label>
                        <input type="number" id="test-channel" value="1" min="1" max="32">
                    </div>
                    
                    <div class="form-group">
                        <label>Reading (PPM)</label>
                        <input type="number" id="test-reading" value="25.5" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label>Gas Type</label>
                        <select id="test-gas">
                            <option value="0">H2S (Hydrogen Sulfide)</option>
                            <option value="1">SO2 (Sulfur Dioxide)</option>
                            <option value="2">O2 (Oxygen)</option>
                            <option value="3">CO (Carbon Monoxide)</option>
                            <option value="4">CL2 (Chlorine)</option>
                            <option value="5">CO2 (Carbon Dioxide)</option>
                            <option value="6">LEL (Lower Explosive Limit)</option>
                            <option value="7">VOC (Volatile Organic Compounds)</option>
                            <option value="8">Tank Level</option>
                            <option value="9">HCl (Hydrogen Chloride)</option>
                            <option value="10">NH3 (Ammonia)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Sensor Type</label>
                        <select id="test-sensor-type">
                            <option value="0">EC (Electrochemical)</option>
                            <option value="1">IR (Infrared)</option>
                            <option value="2">CB (Catalytic Bead)</option>
                            <option value="3">MOS (Metal Oxide)</option>
                            <option value="4">PID (Photoionization)</option>
                            <option value="5">Tank Level</option>
                            <option value="6">4-20mA</option>
                            <option value="7">Switch</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Battery Level (%)</label>
                        <input type="number" id="test-battery" value="85" min="0" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Fault Code</label>
                        <select id="test-fault">
                            <option value="0">None</option>
                            <option value="1">Sensor Board Timeout</option>
                            <option value="2">Bad Reading</option>
                            <option value="3">Current Draw Too High</option>
                            <option value="4">ADC Not Responding</option>
                            <option value="5">Error During Null</option>
                            <option value="7">Checksum Error</option>
                            <option value="8">Duplicate Otis Address (F8 Diagnostic)</option>
                            <option value="9">Sensor Radio Timeout</option>
                            <option value="10">Wired Sensor Not Connected</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Unit Type</label>
                        <select id="test-unit-type">
                            <option value="6900">OI-6900 Series</option>
                            <option value="6940">OI-6940 WireFree</option>
                        </select>
                    </div>
                    
                    <button onclick="sendTestPacket()">üì° Send Test Packet</button>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <h3 style="font-size: 14px; color: #667eea; margin-bottom: 10px;">‚ö†Ô∏è F8 Diagnostic - Change Sensor Address</h3>
                        <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                            Resolve duplicate address conflicts (Fault 8) by commanding a sensor to change its address
                        </p>
                        
                        <div class="form-group">
                            <label>Current Sensor Address</label>
                            <input type="number" id="f8-current-addr" min="1" max="255" placeholder="e.g., 5">
                        </div>
                        
                        <div class="form-group">
                            <label>New Sensor Address</label>
                            <input type="number" id="f8-new-addr" min="1" max="255" placeholder="e.g., 15">
                        </div>
                        
                        <div class="alert-banner" style="margin-bottom: 15px; background: #fee2e2; border-color: #ef4444;">
                            <strong>‚ö†Ô∏è Warning:</strong> Sensor must be in Diagnostic Mode (Mode 5) to accept address changes. This typically requires pressing buttons on the physical sensor.
                        </div>
                        
                        <button onclick="sendF8AddressChange()">üîß Send Address Change Command</button>
                    </div>
                </div>
                
                <div id="radio-wireless-tab" class="tab-content">
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                        Send AT commands wirelessly to remote radios (Primary mode only)
                    </p>
                    
                    <div class="form-group">
                        <label>Quick Commands</label>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="sendWirelessAT('ATCH')">Read Channel</button>
                            <button onclick="sendWirelessAT('ATSY')">Read SysID</button>
                            <button onclick="sendWirelessAT('ATSP')">Read Mode</button>
                            <button onclick="sendWirelessAT('ATAP')">Read API Mode</button>
                            <button onclick="sendWirelessAT('ATBD')">Read Baud</button>
                            <button onclick="sendWirelessAT('ATPL')">Read RF Power</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom AT Command</label>
                        <input type="text" id="wireless-at-cmd" placeholder="ATCH25" maxlength="10">
                    </div>
                    
                    <button onclick="sendCustomWirelessAT()">Send Custom Command</button>
                    
                    <div id="wireless-response" style="margin-top: 15px; display: none;">
                        <label>Response:</label>
                        <div style="background: #1f2937; color: #10b981; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px;" id="wireless-response-text"></div>
                    </div>
                </div>
                
                <div id="radio-advanced-at-tab" class="tab-content">
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                        Direct AT command access with radio selection and sensor mode configuration
                    </p>
                    
                    <div class="form-group">
                        <label>Target Radio</label>
                        <select id="at-target">
                            <option value="local">Local (Connected Radio)</option>
                            <option value="remote">Remote (Wireless via ATRC)</option>
                        </select>
                    </div>
                    
                    <div id="remote-radio-select" style="display: none;">
                        <div class="form-group">
                            <label>Remote Radio Channel</label>
                            <input type="number" id="remote-channel" value="25" min="1" max="78" placeholder="Channel of remote radio">
                            <small style="color: #888;">Channel where remote radio is currently operating</small>
                        </div>
                    </div>
                    
                    <h3 style="font-size: 14px; color: #667eea; margin: 20px 0 10px 0;">Network Configuration</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="sendDirectAT('ATCH')">üì° ATCH - Read Channel</button>
                        <button onclick="sendDirectAT('ATSY')">üî¢ ATSY - Read System ID</button>
                        <button onclick="sendDirectAT('ATSP')">‚öôÔ∏è ATSP - Read Mode</button>
                        <button onclick="sendDirectAT('ATBD')">üì∂ ATBD - Read Baud Rate</button>
                        <button onclick="sendDirectAT('ATPL')">üìä ATPL - Read RF Power</button>
                        <button onclick="sendDirectAT('ATAP')">üîß ATAP - Read API Mode</button>
                    </div>
                    
                    <h3 style="font-size: 14px; color: #667eea; margin: 20px 0 10px 0;">Radio Info</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="sendDirectAT('ATMY')">üÜî ATMY - MAC Address</button>
                        <button onclick="sendDirectAT('ATVR')">üìã ATVR - Firmware Version</button>
                        <button onclick="sendDirectAT('ATDB')">üì° ATDB - Last RSSI</button>
                        <button onclick="sendDirectAT('ATER')">‚ùå ATER - RF Error Count</button>
                        <button onclick="sendDirectAT('ATGD')">‚è±Ô∏è ATGD - Guard Time</button>
                        <button onclick="sendDirectAT('ATRO')">üîÑ ATRO - Packet Timeout</button>
                    </div>
                    
                    <h3 style="font-size: 14px; color: #667eea; margin: 20px 0 10px 0;">Control Commands</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="sendDirectAT('ATWR')">üíæ ATWR - Write to EEPROM</button>
                        <button onclick="sendDirectAT('ATRE')">‚ôªÔ∏è ATRE - Restore Defaults</button>
                        <button onclick="sendDirectAT('ATFR')">üîÑ ATFR - Software Reset</button>
                        <button onclick="sendDirectAT('ATCN')">üö™ ATCN - Exit Command Mode</button>
                    </div>
                    
                    <h3 style="font-size: 14px; color: #10b981; margin: 20px 0 10px 0;">Sensor Mode Configuration</h3>
                    <div style="background: #1f2937; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">
                            Configure sensor operating modes (Mode 5 = 10-second transmit interval)
                        </p>
                        
                        <div class="form-group">
                            <label>Sensor Mode</label>
                            <select id="sensor-mode">
                                <option value="">Select Mode...</option>
                                <option value="0">Mode 0 - Normal (5 min)</option>
                                <option value="1">Mode 1 - Fast (1 min)</option>
                                <option value="2">Mode 2 - Very Fast (30 sec)</option>
                                <option value="3">Mode 3 - Ultra Fast (15 sec)</option>
                                <option value="4">Mode 4 - Rapid (12 sec)</option>
                                <option value="5">Mode 5 - High Speed (10 sec)</option>
                                <option value="6">Mode 6 - Burst (8 sec)</option>
                                <option value="7">Mode 7 - Max (5 sec)</option>
                            </select>
                        </div>
                        
                        <button onclick="setSensorMode()">üöÄ Set Sensor Mode</button>
                        <button onclick="sendDirectAT('ATTM')">üìñ Read Current Mode</button>
                    </div>
                    
                    <h3 style="font-size: 14px; color: #667eea; margin: 20px 0 10px 0;">Custom Command</h3>
                    <div class="form-group">
                        <label>AT Command</label>
                        <input type="text" id="direct-at-cmd" placeholder="ATCH25 or ATSY37" maxlength="20">
                        <small style="color: #888;">Enter any AT command with optional value (no carriage return needed)</small>
                    </div>
                    
                    <button onclick="sendCustomDirectAT()">Send Custom Command</button>
                    
                    <div id="direct-response" style="margin-top: 15px; display: none;">
                        <label>Response:</label>
                        <div style="background: #1f2937; color: #10b981; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;" id="direct-response-text"></div>
                    </div>
                </div>
                
                <div id="radio-scan-tab" class="tab-content">
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                        Scan for radios on different channels and reconfigure them
                    </p>
                    
                    <div class="form-group">
                        <label>Scan Range</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="scan-start" value="1" min="1" max="78" style="width: 80px;">
                            <span>to</span>
                            <input type="number" id="scan-end" value="78" min="1" max="78" style="width: 80px;">
                        </div>
                    </div>
                    
                    <button onclick="scanChannels()" id="scan-btn">üîç Scan Channels</button>
                    <button onclick="stopScan()" class="danger" id="stop-scan-btn" style="display:none;">‚èπ Stop Scan</button>
                    
                    <div id="scan-results" style="margin-top: 15px; display: none;">
                        <h3 style="font-size: 14px; color: #667eea; margin-bottom: 10px;">Found Radios</h3>
                        <div id="found-radios" class="channels-grid"></div>
                    </div>
                    
                    <div id="bulk-config" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb; display: none;">
                        <h3 style="font-size: 14px; color: #667eea; margin-bottom: 10px;">üì° Bulk Reconfigure Selected Radios</h3>
                        
                        <div id="primary-warning" style="display: none;" class="alert-banner" style="margin-bottom: 15px; background: #fee2e2; border-color: #ef4444;">
                            <strong>‚ö†Ô∏è Multiple Primaries Detected!</strong><br>
                            <span id="primary-list"></span><br>
                            This can cause network conflicts. Recommend converting extras to monitors only.
                        </div>
                        
                        <div class="form-group">
                            <label>New Network Channel</label>
                            <input type="number" id="bulk-channel" value="25" min="1" max="78">
                        </div>
                        
                        <div class="form-group">
                            <label>Convert Mode</label>
                            <select id="bulk-mode">
                                <option value="">Keep Current (Sensor or Monitor)</option>
                                <option value="monitor-only">Convert to Monitor Only (115200 baud, no primary)</option>
                                <option value="sensor">Convert to Sensor (9600 baud)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>System ID</label>
                            <input type="number" id="bulk-sysid" value="37" min="0" max="255">
                        </div>
                        
                        <div class="alert-banner" style="margin-bottom: 15px;">
                            <strong>‚ö†Ô∏è Warning:</strong> This will send commands wirelessly to ALL selected radios. After reconfiguration, use "Finalize Network" below.
                        </div>
                        
                        <button onclick="bulkReconfigure()" class="success">‚ú® Reconfigure Selected Radios</button>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                            <h3 style="font-size: 14px; color: #667eea; margin-bottom: 10px;">üéØ Finalize Network</h3>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                                After reconfiguring, designate ONE monitor as primary and gracefully exit the network
                            </p>
                            
                            <div class="form-group">
                                <label>Select Primary Monitor (MAC or Channel)</label>
                                <input type="text" id="primary-mac" placeholder="Enter MAC address or channel number">
                            </div>
                            
                            <button onclick="finalizeNetwork()" class="success">üèÅ Set Primary & Exit Network</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Channel Monitoring -->
        <div class="card">
            <h2>Channel Monitoring</h2>
            
            <button onclick="readChannels()" class="success">üìä Read All Channels</button>
            <button onclick="toggleMonitoring()" id="monitor-btn">üî¥ Start Live Monitoring</button>
            
            <div id="channels" class="channels-grid" style="margin-top: 20px;">
                <p style="color: #666;">Connect to a device and click "Read All Channels"</p>
            </div>
        </div>
        
        <!-- Activity Log -->
        <div class="card">
            <h2>Activity Log</h2>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>
    
    <script>
        const socket = io();
        let monitoringActive = false;
        
        // Socket events
        socket.on('connect', () => {
            log('Connected to server');
        });
        
        socket.on('status', (data) => {
            log(data.message, 'info');
        });
        
        socket.on('error', (data) => {
            log(data.message, 'error');
        });
        
        socket.on('modbus_data', (data) => {
            updateChannelDisplay(data.channels);
        });
        
        socket.on('sensor_data', (data) => {
            log(`Sensor @${data.address} Ch${data.channel}: ${data.gas_type} = ${data.reading.toFixed(1)} PPM | Battery: ${data.battery ? data.battery.toFixed(1) + 'V' : 'N/A'} | ${data.fault}`, data.fault !== 'None' ? 'warning' : 'success');
        });
        
        // Initialize
        window.onload = () => {
            refreshPorts();
            loadMqttConfig();
            
            // Handle monitor model selection
            const modelSelect = document.getElementById('monitor-model');
            const slaveIdGroup = document.getElementById('slave-id-group');
            
            modelSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    slaveIdGroup.style.display = 'block';
                } else {
                    slaveIdGroup.style.display = 'none';
                }
            });
            
            log('OI Monitor Control Center ready', 'info');
        };
        
        // Refresh COM ports
        async function refreshPorts() {
            try {
                const response = await fetch('/api/ports');
                const ports = await response.json();
                
                const modbusSelect = document.getElementById('modbus-port');
                const radioSelect = document.getElementById('radio-port');
                
                modbusSelect.innerHTML = '<option value="">Select Port...</option>';
                radioSelect.innerHTML = '<option value="">Select Port...</option>';
                
                ports.forEach(port => {
                    const option = `<option value="${port.port}">${port.port} - ${port.description}</option>`;
                    modbusSelect.innerHTML += option;
                    radioSelect.innerHTML += option;
                });
                
                log(`Found ${ports.length} COM ports`);
            } catch (error) {
                log(`Error refreshing ports: ${error}`, 'error');
            }
        }
        
        // Modbus functions
        async function connectModbus() {
            const port = document.getElementById('modbus-port').value;
            const model = document.getElementById('monitor-model').value;
            const slaveId = document.getElementById('slave-id').value;
            const baudrate = document.getElementById('baudrate').value;
            
            if (!port) {
                log('Please select a COM port', 'error');
                return;
            }
            
            // Get model name and slave ID
            const modelInfo = {
                '7530': { name: 'OI-7530', defaultSlaveId: 2 },
                '7010': { name: 'OI-7010', defaultSlaveId: 1 },
                '7032': { name: 'OI-7032', defaultSlaveId: 3 },
                'custom': { name: 'Custom Device', defaultSlaveId: parseInt(slaveId) }
            };
            
            const info = modelInfo[model];
            const actualSlaveId = model === 'custom' ? parseInt(slaveId) : info.defaultSlaveId;
            
            log(`Connecting to ${info.name} on ${port} at ${baudrate} baud (Slave ${actualSlaveId})...`, 'info');
            
            try {
                const response = await fetch('/api/modbus/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        port: port, 
                        slave_id: actualSlaveId, 
                        baudrate: parseInt(baudrate),
                        model: info.name
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('modbus-status').textContent = 'Connected';
                    document.getElementById('modbus-status').className = 'status connected';
                    log(data.message, 'success');
                    
                    // Get device info
                    getDeviceInfo();
                } else {
                    log(`Connection failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error connecting: ${error}`, 'error');
            }
        }
        
        async function disconnectModbus() {
            try {
                await fetch('/api/modbus/disconnect', {method: 'POST'});
                document.getElementById('modbus-status').textContent = 'Disconnected';
                document.getElementById('modbus-status').className = 'status disconnected';
                document.getElementById('device-info').style.display = 'none';
                log('Disconnected from Modbus device');
            } catch (error) {
                log(`Error disconnecting: ${error}`, 'error');
            }
        }
        
        async function getDeviceInfo() {
            try {
                const response = await fetch('/api/modbus/device_info');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('info-serial').textContent = data.info.serial_number;
                    document.getElementById('info-model').textContent = data.info.model_number;
                    document.getElementById('info-channel').textContent = data.info.network_channel;
                    document.getElementById('info-uptime').textContent = data.info.uptime_hours + ' hrs';
                    document.getElementById('device-info').style.display = 'block';
                }
            } catch (error) {
                log(`Error getting device info: ${error}`, 'error');
            }
        }
        
        async function readChannels() {
            try {
                const response = await fetch('/api/modbus/read_channels');
                const data = await response.json();
                
                if (data.success) {
                    updateChannelDisplay(data.channels);
                    log(`Read ${data.channels.length} active channels`, 'success');
                } else {
                    log(`Error reading channels: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error: ${error}`, 'error');
            }
        }
        
        function updateChannelDisplay(channels) {
            const container = document.getElementById('channels');
            
            if (channels.length === 0) {
                container.innerHTML = '<p style="color: #666;">No channels available</p>';
                return;
            }
            
            // Show ALL channels, including inactive ones
            container.innerHTML = channels.map(ch => {
                const alertClass = ch.value > 100 ? ' alert' : '';
                const inactiveClass = (!ch.active || ch.value === 0) ? ' style="opacity: 0.5;"' : '';
                return `
                    <div class="channel-card${alertClass}"${inactiveClass}>
                        <div class="channel-number">Ch ${ch.channel}</div>
                        <div class="channel-value">${ch.value.toFixed(2)} <span style="font-size:14px;">PPM</span></div>
                        <div class="channel-gas">${ch.gas_type}</div>
                        ${!ch.active ? '<div style="font-size:10px;color:#999;">Inactive</div>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        function toggleMonitoring() {
            monitoringActive = !monitoringActive;
            const btn = document.getElementById('monitor-btn');
            
            if (monitoringActive) {
                socket.emit('start_monitoring');
                btn.textContent = '‚èπ Stop Live Monitoring';
                btn.style.background = '#ef4444';
                log('Live monitoring started', 'info');
            } else {
                socket.emit('stop_monitoring');
                btn.textContent = 'üî¥ Start Live Monitoring';
                btn.style.background = '#667eea';
                log('Live monitoring stopped', 'info');
            }
        }
        
        // Radio functions
        async function connectRadio() {
            const port = document.getElementById('radio-port').value;
            const baudrate = parseInt(document.getElementById('radio-baudrate').value);
            
            if (!port) {
                log('Please select a COM port for radio', 'error');
                return;
            }
            
            log(`Connecting to radio at ${baudrate} baud...`, 'info');
            
            try {
                const response = await fetch('/api/radio/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({port, baudrate})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('radio-status').textContent = 'Connected';
                    document.getElementById('radio-status').className = 'status connected';
                    log('Radio connected', 'success');
                    getRadioStatus();
                } else {
                    log(`Radio connection failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error connecting radio: ${error}`, 'error');
            }
        }
        
        async function disconnectRadio() {
            try {
                await fetch('/api/radio/disconnect', {method: 'POST'});
                document.getElementById('radio-status').textContent = 'Disconnected';
                document.getElementById('radio-status').className = 'status disconnected';
                document.getElementById('radio-info').style.display = 'none';
                document.getElementById('api-mode-warning').style.display = 'none';
                log('Disconnected from radio');
            } catch (error) {
                log(`Error disconnecting radio: ${error}`, 'error');
            }
        }
        
        async function checkRadioMode() {
            log('Checking radio mode...', 'info');
            
            try {
                const response = await fetch('/api/radio/check_mode');
                const data = await response.json();
                
                if (data.success) {
                    log(`Radio is in ${data.mode} mode`, 'info');
                    
                    if (data.api_mode) {
                        document.getElementById('api-mode-warning').style.display = 'block';
                        log('‚ö†Ô∏è API mode detected! AT commands require CC frame wrapping. Switch to Transparent mode recommended.', 'warning');
                    } else {
                        document.getElementById('api-mode-warning').style.display = 'none';
                        log('‚úì Radio in Transparent mode - AT commands will work normally', 'success');
                    }
                } else {
                    log(`Error checking mode: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error checking radio mode: ${error}`, 'error');
            }
        }
        
        async function switchToTransparent() {
            if (!confirm('Switch radio to Transparent mode?\\n\\nThe radio will reboot and you will need to reconnect.')) {
                return;
            }
            
            log('Switching to Transparent mode...', 'info');
            
            try {
                const response = await fetch('/api/radio/switch_transparent', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(data.message, 'success');
                    document.getElementById('api-mode-warning').style.display = 'none';
                    document.getElementById('radio-status').textContent = 'Disconnected (Rebooting)';
                    document.getElementById('radio-status').className = 'status disconnected';
                    document.getElementById('radio-info').style.display = 'none';
                    log('Wait 3-5 seconds, then reconnect to the radio', 'info');
                } else {
                    log(`Failed to switch mode: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error switching mode: ${error}`, 'error');
            }
        }
        
        async function getRadioStatus() {
            try {
                const response = await fetch('/api/radio/status');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('radio-rssi').textContent = data.rssi + ' dBm';
                    document.getElementById('radio-mac').textContent = data.mac;
                    document.getElementById('radio-info').style.display = 'block';
                }
            } catch (error) {
                log(`Error getting radio status: ${error}`, 'error');
            }
        }
        
        async function readRadioProfile() {
            log('Reading radio EEPROM profile...', 'info');
            
            try {
                const response = await fetch('/api/radio/profile');
                const data = await response.json();
                
                if (data.success) {
                    const profile = data.profile;
                    document.getElementById('profile-channel').textContent = profile.channel || '-';
                    document.getElementById('profile-mode').textContent = profile.mode || '-';
                    document.getElementById('profile-sysid').textContent = profile.system_id || '-';
                    document.getElementById('profile-api').textContent = profile.api_mode || '-';
                    document.getElementById('profile-baud').textContent = profile.baudrate || '-';
                    document.getElementById('profile-power').textContent = profile.rf_power || '-';
                    document.getElementById('radio-profile').style.display = 'block';
                    log('Radio profile loaded', 'success');
                } else {
                    log(`Failed to read profile: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error reading profile: ${error}`, 'error');
            }
        }
        
        async function configureRadio() {
            const channel = document.getElementById('radio-channel').value;
            const isPrimary = document.getElementById('radio-mode').value === 'true';
            const systemId = document.getElementById('radio-sysid').value;
            
            try {
                log('Configuring radio, please wait...', 'info');
                
                const response = await fetch('/api/radio/configure', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        channel: parseInt(channel),
                        is_primary: isPrimary,
                        system_id: parseInt(systemId)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('Radio configured successfully!', 'success');
                    log(`Settings: Channel ${channel}, ${isPrimary ? 'Primary' : 'Secondary'}, SysID ${systemId}`, 'info');
                } else {
                    log(`Configuration failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error configuring radio: ${error}`, 'error');
            }
        }
        
        async function sendTestPacket() {
            const sensorAddr = document.getElementById('test-sensor-addr').value;
            const channel = document.getElementById('test-channel').value;
            const reading = document.getElementById('test-reading').value;
            const gasType = document.getElementById('test-gas').value;
            const sensorType = document.getElementById('test-sensor-type').value;
            const battery = document.getElementById('test-battery').value;
            const fault = document.getElementById('test-fault').value;
            const unitType = document.getElementById('test-unit-type').value;
            
            try {
                const response = await fetch('/api/radio/send_test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sensor_address: sensorAddr ? parseInt(sensorAddr) : null,
                        channel: parseInt(channel),
                        reading: parseFloat(reading),
                        gas_type: parseInt(gasType),
                        sensor_type: parseInt(sensorType),
                        battery: parseInt(battery),
                        fault_code: parseInt(fault),
                        unit_type: unitType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(data.message, 'success');
                } else {
                    log(`Test packet failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error sending test packet: ${error}`, 'error');
            }
        }
        
        async function sendF8AddressChange() {
            const currentAddr = document.getElementById('f8-current-addr').value;
            const newAddr = document.getElementById('f8-new-addr').value;
            
            if (!currentAddr || !newAddr) {
                log('Please enter both current and new addresses', 'error');
                return;
            }
        
        async function enableApiMode() {
            if (!confirm('This will enable API mode on the radio and reboot it. You will need to reconnect after. Continue?')) {
                return;
            }
            
            log('Enabling API mode on radio...', 'info');
            
            try {
                const response = await fetch('/api/radio/enable_api_mode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(data.message, 'success');
                    log('Radio rebooting... Please wait 5 seconds then reconnect.', 'info');
                } else {
                    log(`Failed to enable API mode: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error enabling API mode: ${error}`, 'error');
            }
        }
        
        async function toggleCommandMode() {
            const checkbox = document.getElementById('command-mode-toggle');
            const isEntering = checkbox.checked;
            
            try {
                log(isEntering ? 'Entering command mode...' : 'Exiting command mode...', 'info');
                
                const response = await fetch('/api/radio/command_mode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enter: isEntering })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(data.message, 'success');
                } else {
                    log(`Failed: ${data.error}`, 'error');
                    // Revert checkbox on failure
                    checkbox.checked = !isEntering;
                }
            } catch (error) {
                log(`Error: ${error}`, 'error');
                checkbox.checked = !isEntering;
            }
        }
            
            if (currentAddr === newAddr) {
                log('Current and new addresses must be different', 'error');
                return;
            }
            
            if (!confirm(`Change sensor address from ${currentAddr} to ${newAddr}?\\n\\nWARNING: Sensor must be in Diagnostic Mode (Mode 5) to accept this command!`)) {
                return;
            }
            
            try {
                log(`Sending F8 address change command: ${currentAddr} ‚Üí ${newAddr}`, 'info');
                
                const response = await fetch('/api/radio/f8_address_change', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_address: parseInt(currentAddr),
                        new_address: parseInt(newAddr)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(data.message, 'success');
                    log('Check sensor display to verify address change', 'info');
                } else {
                    log(`F8 command failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error sending F8 command: ${error}`, 'error');
            }
        }
        
        // Tab switching
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Set active tab button
            event.target.classList.add('active');
        }
        
        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6';
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span style="color: ${color}">${message}</span>`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // MQTT functions
        async function loadMqttConfig() {
            try {
                const response = await fetch('/api/mqtt/config');
                const config = await response.json();
                
                document.getElementById('mqtt-broker').value = config.broker;
                document.getElementById('mqtt-port').value = config.port;
                document.getElementById('mqtt-username').value = config.username || '';
                document.getElementById('mqtt-password').value = config.password || '';
                document.getElementById('mqtt-topic').value = config.base_topic;
            } catch (error) {
                log(`Error loading MQTT config: ${error}`, 'error');
            }
        }
        
        async function saveMqttConfig() {
            const config = {
                broker: document.getElementById('mqtt-broker').value,
                port: parseInt(document.getElementById('mqtt-port').value),
                username: document.getElementById('mqtt-username').value,
                password: document.getElementById('mqtt-password').value,
                base_topic: document.getElementById('mqtt-topic').value
            };
            
            try {
                const response = await fetch('/api/mqtt/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('MQTT configuration saved', 'success');
                } else {
                    log(`Error saving MQTT config: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error saving MQTT config: ${error}`, 'error');
            }
        }
        
        async function testMqttConnection() {
            log('Testing MQTT connection...', 'info');
            
            try {
                const response = await fetch('/api/mqtt/test', {method: 'POST'});
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('mqtt-status').textContent = 'Connected';
                    document.getElementById('mqtt-status').className = 'status connected';
                    log('MQTT connection successful!', 'success');
                } else {
                    document.getElementById('mqtt-status').textContent = 'Failed';
                    document.getElementById('mqtt-status').className = 'status disconnected';
                    log(`MQTT connection failed: ${data.error}`, 'error');
                }
            } catch (error) {
                document.getElementById('mqtt-status').textContent = 'Error';
                document.getElementById('mqtt-status').className = 'status disconnected';
                log(`Error testing MQTT: ${error}`, 'error');
            }
        }
        
        async function sendWirelessAT(command) {
            log(`Sending wireless AT command: ${command}`, 'info');
            
            try {
                const response = await fetch('/api/radio/wireless_at', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('wireless-response').style.display = 'block';
                    document.getElementById('wireless-response-text').textContent = data.response || 'OK';
                    log(`Response: ${data.response || 'OK'}`, 'success');
                } else {
                    log(`Wireless AT failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error sending wireless AT: ${error}`, 'error');
            }
        }
        
        async function sendCustomWirelessAT() {
            const command = document.getElementById('wireless-at-cmd').value.toUpperCase();
            
            if (!command || !command.startsWith('AT')) {
                log('Command must start with AT', 'error');
                return;
            }
            
            await sendWirelessAT(command);
        }
        
        // Advanced AT Commands
        async function sendDirectAT(command) {
            const target = document.getElementById('at-target').value;
            const responseDiv = document.getElementById('direct-response');
            const responseText = document.getElementById('direct-response-text');
            
            log(`Sending ${target} AT command: ${command}`, 'info');
            
            try {
                let endpoint, body;
                
                if (target === 'local') {
                    // Send to local radio via command mode
                    endpoint = '/api/radio/direct_at';
                    body = {command: command};
                } else {
                    // Send to remote radio via ATRC
                    const remoteChannel = document.getElementById('remote-channel').value;
                    endpoint = '/api/radio/remote_at';
                    body = {command: command, channel: parseInt(remoteChannel)};
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    responseDiv.style.display = 'block';
                    responseText.textContent = data.response || 'OK';
                    log(`AT command successful: ${data.response}`, 'success');
                } else {
                    responseDiv.style.display = 'block';
                    responseText.textContent = `ERROR: ${data.error}`;
                    log(`AT command failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error sending AT command: ${error}`, 'error');
            }
        }
        
        async function sendCustomDirectAT() {
            const command = document.getElementById('direct-at-cmd').value.toUpperCase();
            
            if (!command || !command.startsWith('AT')) {
                log('Command must start with AT', 'error');
                return;
            }
            
            await sendDirectAT(command);
        }
        
        async function setSensorMode() {
            const mode = document.getElementById('sensor-mode').value;
            
            if (mode === '') {
                log('Please select a sensor mode', 'error');
                return;
            }
            
            // ATTM command sets sensor transmit mode
            const command = `ATTM${mode}`;
            log(`Setting sensor to Mode ${mode}...`, 'info');
            await sendDirectAT(command);
        }
        
        // Show/hide remote radio options
        document.getElementById('at-target').addEventListener('change', function() {
            const remoteDiv = document.getElementById('remote-radio-select');
            remoteDiv.style.display = this.value === 'remote' ? 'block' : 'none';
        });
        
        // Channel scanning
        let scanActive = false;
        let foundRadios = [];
        
        async function scanChannels() {
            const startCh = parseInt(document.getElementById('scan-start').value);
            const endCh = parseInt(document.getElementById('scan-end').value);
            
            if (startCh > endCh) {
                log('Start channel must be less than end channel', 'error');
                return;
            }
            
            scanActive = true;
            foundRadios = [];
            document.getElementById('scan-btn').style.display = 'none';
            document.getElementById('stop-scan-btn').style.display = 'inline-block';
            document.getElementById('scan-results').style.display = 'none';
            
            log(`Scanning channels ${startCh} to ${endCh}...`, 'info');
            
            try {
                const response = await fetch('/api/radio/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({start: startCh, end: endCh})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    foundRadios = data.radios;
                    displayFoundRadios(foundRadios);
                    log(`Scan complete! Found ${foundRadios.length} radios`, 'success');
                } else {
                    log(`Scan failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Scan error: ${error}`, 'error');
            } finally {
                scanActive = false;
                document.getElementById('scan-btn').style.display = 'inline-block';
                document.getElementById('stop-scan-btn').style.display = 'none';
            }
        }
        
        function stopScan() {
            scanActive = false;
            log('Scan stopped by user', 'info');
        }
        
        function displayFoundRadios(radios) {
            const container = document.getElementById('found-radios');
            
            if (radios.length === 0) {
                container.innerHTML = '<p style="color: #666;">No radios found on scanned channels</p>';
                document.getElementById('scan-results').style.display = 'block';
                return;
            }
            
            // Detect multiple primaries
            const primaries = radios.filter(r => r.is_primary);
            if (primaries.length > 1) {
                document.getElementById('primary-warning').style.display = 'block';
                const primaryList = primaries.map(p => `Channel ${p.channel} (${p.mac || 'unknown MAC'})`).join(', ');
                document.getElementById('primary-list').textContent = `Found ${primaries.length} primaries: ${primaryList}`;
            } else {
                document.getElementById('primary-warning').style.display = 'none';
            }
            
            container.innerHTML = radios.map((radio, idx) => {
                const cardClass = radio.is_primary ? 'channel-card' : 'channel-card';
                const roleLabel = radio.type === 'sensor' ? 'üîµ Sensor' : (radio.is_primary ? 'üü¢ Monitor (Primary)' : 'üü° Monitor');
                
                return `
                    <div class="${cardClass}" style="${radio.is_primary ? 'border-left-color: #10b981;' : ''}">
                        <input type="checkbox" id="radio-${idx}" checked style="margin-right: 5px;">
                        <label for="radio-${idx}">
                            <div class="channel-number">Channel ${radio.channel}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${roleLabel}<br>
                                SysID: ${radio.system_id}<br>
                                Baud: ${radio.baudrate}<br>
                                ${radio.mac ? 'MAC: ' + radio.mac : ''}
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
            
            document.getElementById('scan-results').style.display = 'block';
            document.getElementById('bulk-config').style.display = 'block';
        }
        
        async function bulkReconfigure() {
            const newChannel = parseInt(document.getElementById('bulk-channel').value);
            const mode = document.getElementById('bulk-mode').value;
            const systemId = parseInt(document.getElementById('bulk-sysid').value);
            
            // Get selected radios
            const selectedRadios = [];
            foundRadios.forEach((radio, idx) => {
                if (document.getElementById(`radio-${idx}`)?.checked) {
                    selectedRadios.push(radio);
                }
            });
            
            if (selectedRadios.length === 0) {
                log('No radios selected', 'error');
                return;
            }
            
            if (!confirm(`Reconfigure ${selectedRadios.length} radios to channel ${newChannel}?`)) {
                return;
            }
            
            log(`Starting bulk reconfiguration of ${selectedRadios.length} radios...`, 'info');
            
            try {
                const response = await fetch('/api/radio/bulk_configure', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        radios: selectedRadios,
                        new_channel: newChannel,
                        mode: mode,
                        system_id: systemId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`Successfully reconfigured ${data.configured} radios!`, 'success');
                    log('Details: ' + data.message, 'info');
                    
                    // Clear results
                    document.getElementById('scan-results').style.display = 'none';
                    document.getElementById('bulk-config').style.display = 'none';
                } else {
                    log(`Bulk reconfigure failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error during bulk reconfigure: ${error}`, 'error');
            }
        }
        
        async function finalizeNetwork() {
            const primaryMac = document.getElementById('primary-mac').value;
            
            if (!primaryMac) {
                log('Please enter MAC address or channel of primary monitor', 'error');
                return;
            }
            
            if (!confirm(`Set ${primaryMac} as primary and exit network?`)) {
                return;
            }
            
            log('Finalizing network configuration...', 'info');
            
            try {
                const response = await fetch('/api/radio/finalize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({primary_identifier: primaryMac})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('Network finalized! Primary set and connection closed.', 'success');
                    log(data.message, 'info');
                    
                    // Update UI to disconnected state
                    radioConnected = false;
                    document.getElementById('radio-status').textContent = 'Disconnected';
                    document.getElementById('radio-status').className = 'status-indicator disconnected';
                } else {
                    log(`Finalization failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error finalizing network: ${error}`, 'error');
            }
        }
    </script>
</body>
</html>
